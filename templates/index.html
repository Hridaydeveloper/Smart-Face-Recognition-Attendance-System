<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Smart Face Attendance</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
  <style>
    body {
  font-family: 'Poppins', sans-serif;
  background: #0e0e0e;
  color: #f0f0f0;
  display: flex;
  flex-direction: row;
  height: 100vh;
}

.left-panel, .right-panel {
  padding: 40px;
}

.left-panel {
  width: 35%;
  background-color: #1a1a1a;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  border-right: 1px solid #333;
}

.left-panel h2 {
  margin-bottom: 20px;
  font-size: 1.8rem;
  font-weight: 600;
  color: #ffffff;
  text-align: center;
}

input[type="text"] {
  padding: 12px;
  width: 100%;
  margin-bottom: 20px;
  border-radius: 6px;
  border: 1px solid #888;
  background-color: #2a2a2a;
  color: #f0f0f0;
  font-size: 16px;
}

button {
  padding: 12px 20px;
  font-size: 16px;
  border: 1px solid white;
  border-radius: 6px;
  cursor: pointer;
  background-color: #fff;
  color: #111;
  transition: all 0.3s ease;
  margin-bottom: 12px;
  font-weight: 550;
}

button:hover {
  background-color: #e0e0e0;
  color: #000;
  transform: scale(1.02);
}

#status {
  margin-top: 30px;
  font-size: 16px;
  font-weight: 600;
}

.right-panel {
  flex: 1;
  background: #0e0e0e;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  position: relative;
}

.video-container {
  position: relative;
  width: 90%;
  max-width: 800px;
  margin: 0 auto;
}

#video, #overlay {
  width: 100%;
  height: auto;
  border-radius: 10px;
  border: 2px solid #fff;
  box-shadow: 0 0 25px rgba(255, 255, 255, 0.3);
  display: block;
}

#overlay {
  position: absolute;
  top: 0;
  left: 0;
  pointer-events: none;
  border: none !important;
  box-shadow: none !important;
}

#canvas {
  display: none !important;
  border: none !important;
  box-shadow: none !important;
}

.action-btns {
  margin-top: 20px;
  display: flex;
  flex-direction: column;
  align-items: center;
}

.water-mark {
  margin-top: 60px;
  color: #777;
  font-size: 14px;
}

/* Responsive for small screens */
@media screen and (max-width: 768px) {
  body {
    flex-direction: column;
    height: auto;
    align-items: center;
    justify-content: center;
  }

  .left-panel, .right-panel {
    width: 100%;
    padding: 20px;
    text-align: center;
    align-items: center;
    justify-content: center;
  }

  .left-panel {
    border-right: none;
    border-bottom: 1px solid #333;
  }

  input[type="text"], button {
    width: 90%;
  }

  .video-container {
    width: 95%;
    margin: 0 auto;
  }

  #video, #overlay {
    width: 100% !important;
    height: auto !important;
    border-radius: 10px;
    border: 2px solid #fff;
  }

  #canvas {
    display: none !important;
  }
 
}
  </style>
</head>
<body>

  <div class="left-panel">
    <h2>Register New Face</h2>
    <input type="text" id="nameInput" placeholder="Enter your name">
    <button onclick="captureImage()">Capture Image</button>
    <button onclick="confirmRegistration()">Confirm Registration</button>
    <button onclick="toggleUserList()" id="toggleUserBtn">Show Registered Users</button>
    <p class="capture-info" id="captureCount">Captured: 0</p>
    <div id="userList" style="display: none; font-size: 14px; margin-top: 10px;"></div>
    <div id="status">Waiting for camera access...</div>
  </div>

  <div class="right-panel">
    <div class="video-container">
      <video id="video" autoplay playsinline></video>
      <canvas id="overlay"></canvas>
    </div>
    <canvas id="canvas" width="400" height="300" style="display: none;"></canvas>
    
    <div class="action-btns">
      <button onclick="switchCamera()">Switch Camera</button>
      <button onclick="takeAttendance()">Take Attendance</button>
    </div>
    <div class="water-mark">
      <h3>Powered by Hriday Das</h3>
    </div>
  </div>

  <script>
    const video = document.getElementById("video");
    const canvas = document.getElementById("canvas");
    const overlay = document.getElementById("overlay");
    const statusText = document.getElementById("status");
    const captureCountText = document.getElementById("captureCount");
    const userList = document.getElementById("userList");
    const toggleUserBtn = document.getElementById("toggleUserBtn");

    let capturedImages = [];
    let captureCount = 0;
    let currentFacingMode = "user";
    let currentStream = null;

    function startCamera(facingMode = "user") {
      if (currentStream) {
        currentStream.getTracks().forEach(track => track.stop());
      }

      const constraints = {
        video: { facingMode: { exact: facingMode } }
      };

      navigator.mediaDevices.getUserMedia(constraints)
        .then(stream => {
          currentStream = stream;
          video.srcObject = stream;
          setStatus("Camera ready.", "#33ccff");
        })
        .catch(() => {
          navigator.mediaDevices.getUserMedia({ video: { facingMode: facingMode } })
            .then(stream => {
              currentStream = stream;
              video.srcObject = stream;
              setStatus("Camera ready (fallback).", "#ffff00");
            })
            .catch(err => {
              console.error("Camera access error:", err);
              setStatus("Camera access denied.", "#ff3333");
            });
        });
    }

    function switchCamera() {
      currentFacingMode = currentFacingMode === "user" ? "environment" : "user";
      startCamera(currentFacingMode);
    }

    startCamera("user");

    function getImageData() {
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      const ctx = canvas.getContext('2d', { willReadFrequently: true });
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

      const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
      const gray = ctx.createImageData(imageData.width, imageData.height);
      for (let i = 0; i < imageData.data.length; i += 4) {
        let avg = (imageData.data[i] + imageData.data[i+1] + imageData.data[i+2]) / 3;
        gray.data[i] = gray.data[i+1] = gray.data[i+2] = avg;
        gray.data[i+3] = imageData.data[i+3];
      }
      ctx.putImageData(gray, 0, 0);

      return canvas.toDataURL('image/jpeg');
    }

    function captureImage() {
      const image = getImageData();
      capturedImages.push(image);
      captureCount++;
      captureCountText.textContent = `Captured: ${captureCount}`;
      setStatus("Image captured.", "#33ccff");
    }

    function confirmRegistration() {
      const name = document.getElementById("nameInput").value.trim();
      if (!name || capturedImages.length === 0) {
        alert("Please enter a name and capture at least one image.");
        return;
      }

      setStatus(`Registering ${capturedImages.length} images for ${name}...`, "#33ccff");

      fetch('/register-multiple', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name: name, images: capturedImages })
      })
      .then(res => res.json())
      .then(data => {
        setStatus(data.message, data.status === "success" ? "#33cc33" : "#ff3333");
        captureCount = 0;
        capturedImages = [];
        captureCountText.textContent = "Captured: 0";
      })
      .catch(err => {
        console.error(err);
        setStatus("Registration failed.", "#ff3333");
      });
    }

    function takeAttendance() {
      const image = getImageData();
      setStatus("Taking attendance...", "#33ccff");

      fetch('/start-attendance', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ image: image })
      })
      .then(res => res.json())
      .then(data => {
        let ctx = overlay.getContext("2d");
        overlay.width = video.videoWidth;
        overlay.height = video.videoHeight;
        ctx.clearRect(0, 0, overlay.width, overlay.height);

        let boxColor = "#ffff00"; // default yellow
        if (data.status === "success") {
          boxColor = "#33cc33";
        } else {
          boxColor = "#ff3333";
        }

        ctx.strokeStyle = boxColor;
        ctx.lineWidth = 3;
        ctx.strokeRect(50, 50, overlay.width - 100, overlay.height - 100); // fake box
        ctx.fillStyle = boxColor;
        ctx.font = "20px Poppins";
        ctx.textAlign = "center";
        ctx.fillText(data.message, overlay.width / 2, 40);

        setStatus(data.message, boxColor);
      })
      .catch(err => {
        console.error(err);
        setStatus("Error during attendance.", "#ff3333");
      });
    }

    function setStatus(message, color) {
      statusText.textContent = message;
      statusText.style.color = color;
    }

    function toggleUserList() {
      if (userList.style.display === "none") {
        fetch('/list-users')
          .then(res => {
            if (!res.ok) throw new Error("Failed to load users");
            return res.json();
          })
          .then(data => {
            userList.innerHTML = "<strong>Registered Users:</strong><br>" + data.users.join("<br>");
            userList.style.display = "block";
            toggleUserBtn.textContent = "Hide Registered Users";
          })
          .catch(err => {
            console.error("Error fetching users:", err);
            setStatus("Error loading users", "#ff3333");
          });
      } else {
        userList.style.display = "none";
        toggleUserBtn.textContent = "Show Registered Users";
      }
    }
  </script>
</body>
</html>
